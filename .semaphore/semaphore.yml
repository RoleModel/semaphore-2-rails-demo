version: v1.0
name: Semaphore 2 Rails Demo
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
auto_cancel:
  running:
    when: "branch != 'master'"

blocks:
  - name: Build
    dependencies: []
    execution_time_limit:
      minutes: 20
    task:
      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu1804
      env_vars:
        - name: TEST_DATABASE_URL
          value: postgres://postgres:@0.0.0.0/semaphore_2_rails_demo_test
        - name: RAILS_ENV
          value: test
        - name: HONEYBADGER_SOURCE_MAP_DISABLED
          value: "true"
        - name: TZ
          value: America/New_York
        - name: GOOGLE_MAPS_API_KEY
          value: AIzninjamaster

      prologue:
        commands:
          - checkout
          - sem-service start postgres --username=postgres
          - sem-version ruby $(cat .ruby-version)
          - sem-version node $(cat .node-version)
          - gem install bundler --no-document
          - npm i -g yarn
          - bundle config set deployment 'true'
          - bundle config set path 'vendor/bundle'
          - cache restore gems-$(checksum .ruby-version)-$(checksum Gemfile.lock)
          - cache restore yarn-cache-$(checksum .node-version)-$(checksum yarn.lock)
          - cache restore yarn-node-modules-$(checksum .node-version)-$(checksum yarn.lock)

      jobs:
        - name: Install Dependencies, Run Tests
          commands:
            - bundle check || bundle install
            - yarn check || yarn install
            - cache store gems-$(checksum .ruby-version)-$(checksum Gemfile.lock) vendor/bundle
            - cache store yarn-cache-$(checksum .node-version)-$(checksum yarn.lock) /home/semaphore/.cache/yarn
            - cache store yarn-node-modules-$(checksum .node-version)-$(checksum yarn.lock) node_modules
            - bundle exec rails db:setup
            - bundle exec rails webpacker:compile
            - bundle exec rake
      epilogue:
        on_fail:
          commands:
            - artifact push job log/test.log
            - artifact push job tmp/screenshots
            - ls spec/e2e/screenshots
